<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DayZ Base Planner</title>
<script src="https://unpkg.com/konva@9/konva.min.js"></script>

<style>
body { margin:0; background:#111; color:#fff; font-family:Arial; }
.container { display:flex; height:100vh; }
.sidebar {
  width:280px;
  background:#1b1b1b;
  padding:15px;
  overflow-y:auto;
  border-right:1px solid #333;
}
.stageWrap { flex:1; background:#0d0d0d; }

select, button, input[type="range"] {
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #333;
  background:#222;
  color:white;
}

button { cursor:pointer; background:#2a2a2a; }
button:hover { background:#333; }

.label { font-size:12px; color:#aaa; margin-bottom:5px; }
.small { font-size:12px; color:#bbb; line-height:1.35; margin: 6px 0 10px; }
hr { border:0; border-top:1px solid #333; margin:15px 0; }
</style>
</head>

<body>
<div class="container">

<div class="sidebar">
<h2>Base Planner</h2>

<div class="label">Choose Base</div>
<select id="baseSelect">
  <option value="Tier2.png">Tier 2</option>
  <option value="Tier3.png">Tier 3</option>
  <option value="Tier4.png">Tier 4</option>
</select>

<button onclick="loadBase()">Load Base</button>

<div id="msg" class="small"></div>

<hr>

<div class="label">Large Structures</div>
<select id="largeSelect">
  <option value="atc_building.png">ATC Building</option>
</select>
<button onclick="placeStructure()">Place Large</button>

<hr>

<div class="label">Selected Width</div>
<input type="range" min="60" max="600" value="240" id="sizeSlider" disabled>

<button onclick="rotateSelected()">Rotate 90°</button>
<button onclick="deleteSelected()">Delete</button>
<button onclick="exportLayout()">Export JSON</button>

</div>

<div id="stageWrap" class="stageWrap"></div>
</div>

<script>
const stage = new Konva.Stage({
  container: 'stageWrap',
  width: window.innerWidth - 280,
  height: window.innerHeight
});
const layer = new Konva.Layer();
stage.add(layer);

let selectedShape = null;
let backgroundNode = null;

const msg = document.getElementById("msg");
function showMsg(html){ msg.innerHTML = html; }

// Loads an image with onerror + proper URL encoding for spaces
function loadImg(src, onOk){
  const img = new Image();
  img.onload = () => onOk(img);
  img.onerror = () => showMsg(
    `❌ Could not load: <b>${src}</b><br>
     This usually means the image is not uploaded to GitHub Pages in the same folder as index.html,
     or the filename/case doesn't match exactly.`
  );
  img.src = encodeURI(src);
}

function loadBase(){
  const src = document.getElementById("baseSelect").value;

  loadImg(src, (img) => {
    if(backgroundNode) backgroundNode.destroy();

    const scale = Math.min(stage.width()/img.width, stage.height()/img.height);

    backgroundNode = new Konva.Image({
      x:(stage.width()-img.width*scale)/2,
      y:(stage.height()-img.height*scale)/2,
      image:img,
      width:img.width*scale,
      height:img.height*scale,
      listening:false
    });

    layer.add(backgroundNode);
    backgroundNode.moveToBottom();
    layer.draw();

    showMsg(`✅ Loaded base: <b>${src}</b>`);
  });
}

loadBase(); // auto load default base

function placeStructure(){
  const src = document.getElementById("largeSelect").value;

  loadImg(src, (img) => {
    const width = 240;
    const height = (img.height/img.width) * width;

    const node = new Konva.Image({
      x:300,
      y:200,
      image:img,
      width:width,
      height:height,
      draggable:true,
      name:"ATC Building"
    });

    node.setAttr("ratio", height/width);

    node.on("click tap", function(){
      selectedShape = node;
      document.getElementById("sizeSlider").disabled = false;
      document.getElementById("sizeSlider").value = node.width();
    });

    layer.add(node);
    layer.draw();
    showMsg(`✅ Placed: <b>${src}</b>`);
  });
}

document.getElementById("sizeSlider").addEventListener("input", function(){
  if(!selectedShape) return;

  const newWidth = parseInt(this.value);
  const ratio = selectedShape.getAttr("ratio");
  selectedShape.width(newWidth);
  selectedShape.height(newWidth * ratio);
  layer.draw();
});

function rotateSelected(){
  if(!selectedShape) return;
  selectedShape.rotation(selectedShape.rotation()+90);
  layer.draw();
}

function deleteSelected(){
  if(!selectedShape) return;
  selectedShape.destroy();
  selectedShape = null;
  document.getElementById("sizeSlider").disabled = true;
  layer.draw();
}

function exportLayout(){
  const items=[];
  layer.getChildren().forEach(node=>{
    if(node !== backgroundNode){
      items.push({
        name: node.name(),
        x: node.x(),
        y: node.y(),
        rotation: node.rotation(),
        width: node.width(),
        height: node.height()
      });
    }
  });

  const data=JSON.stringify(items,null,2);
  const blob=new Blob([data],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="layout.json";
  a.click();
}

window.addEventListener("resize", function(){
  stage.width(window.innerWidth - 280);
  stage.height(window.innerHeight);
  loadBase();
});
</script>

</body>
</html>